<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ShoppingGPT Chat</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>
  <section class="msger">
    <header class="msger-header">
      <h1 class="msger-title">ShoppingGPT Assistant</h1>
    </header>
    <main class="msger-chat">
      <div class="msg left-msg">
        <div class="msg-bubble">
          <div class="msg-info">
            <span class="msg-info-name">ShoppingGPT</span>
            <span class="msg-info-time">Just now</span>
          </div>
          <div class="msg-text">Hi there! How can I help you today?</div>
        </div>
      </div>
    </main>
    <form class="msger-inputarea" autocomplete="off">
      <input type="text" class="msger-input" id="textInput" placeholder="Type a message" required>
      <button type="submit" class="msger-send-btn">Send</button>
    </form>
  </section>

  <script>
    const msgerForm = document.querySelector('.msger-inputarea');
    const msgerInput = document.querySelector('.msger-input');
    const msgerChat = document.querySelector('.msger-chat');

    const BOT_NAME = 'ShoppingGPT';
    const PERSON_NAME = 'You';

    msgerForm.addEventListener('submit', event => {
      event.preventDefault();

      const msgText = msgerInput.value.trim();
      if (!msgText) return;

      appendMessage(PERSON_NAME, 'right', msgText);
      msgerInput.value = '';
      botResponse(msgText);
    });

    function appendMessage(name, side, text) {
      const msgHTML = `
        <div class="msg ${side}-msg">
          <div class="msg-bubble">
            <div class="msg-info">
              <span class="msg-info-name">${name}</span>
              <span class="msg-info-time">${formatDate(new Date())}</span>
            </div>
            <div class="msg-text">${text}</div>
          </div>
        </div>`;

      msgerChat.insertAdjacentHTML('beforeend', msgHTML);
      msgerChat.scrollTop = msgerChat.scrollHeight;
    }

    function botResponse(rawText) {
      $.get('/get', { msg: rawText }).done(function (data) {
        if (data && data.response) {
          const formattedText = data.response.replace(/\n/g, '<br>');
          appendMessage(BOT_NAME, 'left', formattedText);
        } else {
          appendMessage(BOT_NAME, 'left', "Sorry, I couldn't process your request.");
        }
      }).fail(function () {
        appendMessage(BOT_NAME, 'left', 'Sorry, there was an error processing your request.');
      });
    }

    function formatDate(date) {
      const hours = `0${date.getHours()}`.slice(-2);
      const minutes = `0${date.getMinutes()}`.slice(-2);
      return `${hours}:${minutes}`;
    }
  </script>
</body>
</html>
